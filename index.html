<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TRC Factory Control</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f4f7f6; font-family: 'Segoe UI', sans-serif; }
    .header-bar { background: #fff; padding: 10px 25px; border-bottom: 2px solid #dee2e6; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .card-custom { border: none; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); background: #fff; padding: 20px; }
    .nav-pills .nav-link.active { background-color: #0d6efd; box-shadow: 0 4px 8px rgba(13, 110, 253, 0.3); }
    .report-table th { background: #BDD7EE; border: 1px solid #444; font-size: 11px; text-align: center; vertical-align: middle; }
    .report-table td { border: 1px solid #ddd; text-align: center; }
    .row-hourly-inp { background-color: #fff9db !important; }
    .inp-hourly { width: 100%; border: none; background: transparent; text-align: center; font-weight: bold; color: #d63384; outline: none; }
    .btn-sync { font-size: 9px; padding: 2px 5px; margin-top: 3px; font-weight: bold; width: 100%; transition: 0.3s; }
    .btn-synced { background-color: #198754 !important; border-color: #198754 !important; color: white !important; }
    .qty-link { color: #0d6efd; text-decoration: underline; font-weight: bold; cursor: pointer; border: none; background: none; }
    .has-details { background-color: #d1e7dd !important; border-radius: 4px; }
    .total-box { background: #212529; color: #fff; border-radius: 12px; padding: 15px; margin-top: 20px; display: flex; justify-content: space-around; }
    .total-val { font-size: 22px; font-weight: 800; display: block; color: #ffc107; }
    .total-label { font-size: 10px; text-transform: uppercase; color: #adb5bd; }
  </style>
</head>
<body>

<div class="header-bar d-flex justify-content-between align-items-center">
  <div class="d-flex align-items-center"><img src="https://i.postimg.cc/5y7SN4xc/logo.png" height="40" class="me-4">
    <ul class="nav nav-pills" id="pills-tab">
      <li class="nav-item"><button class="nav-link active" onclick="switchTab('entry')">Hourly Entry</button></li>
      <li class="nav-item"><button class="nav-link" onclick="switchTab('summary'); fetchGlobalData();">Line-Wise Summary</button></li>
    </ul>
  </div>
  <div id="loader" class="spinner-border spinner-border-sm text-primary" style="display:none"></div>
</div>

<div class="container-fluid py-4">
  
  <!-- TAB 1: HOURLY ENTRY -->
  <div id="sectionEntry">
    <div class="card card-custom mb-4">
      <div class="row g-2">
        <div class="col-md-2"><small class="fw-bold">Date</small><input type="date" id="iDate" class="form-control form-control-sm"></div>
        <div class="col-md-3"><small class="fw-bold">Product</small><select id="iProd" class="form-select form-select-sm"><option value="BUDS">BUDS</option><option value="CC">CC</option></select></div>
        <div class="col-md-3"><small class="fw-bold">Model</small><select id="iModel" class="form-select form-select-sm"></select></div>
        <div class="col-md-2"><small class="fw-bold">Your Line</small><input type="text" id="iLine" class="form-control form-control-sm" placeholder="e.g. 1"></div>
        <div class="col-md-2"><small class="fw-bold">Shift</small><select id="iShift" class="form-select form-select-sm"><option>Day</option><option>Night</option></select></div>
      </div>
    </div>

    <div class="card card-custom">
      <div class="d-flex gap-2 mb-3">
        <select id="defSel" class="form-select form-select-sm w-25"></select>
        <button class="btn btn-primary btn-sm px-4" onclick="addDefectRow()">+ Add Defect</button>
      </div>
      <div class="table-responsive">
        <table class="table report-table">
          <thead>
            <tr id="timeRow"><th>Defect / Time</th></tr>
            <tr id="inputRow" class="row-hourly-inp"><th class="text-end pe-3">HOURLY INPUT →</th></tr>
            <tr id="syncRow"><th>SYNC ACTION →</th></tr>
          </thead>
          <tbody id="gridBody"></tbody>
        </table>
      </div>

      <div class="total-box shadow">
          <div class="text-center"> <span class="total-label">Total Input</span> <span class="total-val" id="dispInp">0</span> </div>
          <div class="text-center"> <span class="total-label">Total Defects</span> <span class="total-val text-danger" id="dispDef">0</span> </div>
          <div class="text-center"> <span class="total-label">FPY Yield</span> <span class="total-val text-success" id="dispFPY">100%</span> </div>
      </div>

      <div class="text-center mt-4">
        <!-- REPLACED FINAL SUBMIT WITH RESET SHIFT -->
        <button class="btn btn-danger px-5 fw-bold" onclick="resetShift()">RESET SHIFT (Clear All)</button>
      </div>
    </div>
  </div>

  <!-- TAB 2: LINE-WISE SUMMARY -->
  <div id="sectionSummary" style="display:none">
    <div class="card card-custom">
        <div class="row align-items-end mb-4">
            <div class="col-md-8"><h4>Line-Wise Production Summary</h4></div>
            <div class="col-md-3">
                <small class="fw-bold">Check Data for Date:</small>
                <input type="date" id="summaryDate" class="form-control form-control-sm">
            </div>
            <div class="col-md-1">
                <button class="btn btn-primary btn-sm w-100" onclick="fetchGlobalData()">Refresh</button>
            </div>
        </div>
        <table class="table table-bordered align-middle">
            <thead class="table-dark"><tr><th>Line No</th><th>Product</th><th>Input</th><th>Defects</th><th>Yield %</th></tr></thead>
            <tbody id="sumTableBody"></tbody>
        </table>
    </div>
  </div>

</div>

<!-- Modal -->
<div class="modal fade" id="eModal" tabindex="-1"><div class="modal-dialog modal-xl"><div class="modal-content">
  <div class="modal-header"><h5 id="mHeader">Details</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
  <div class="modal-body"><table class="table table-bordered small"><thead style="background:#BDD7EE"><tr><th>Cause</th><th>Stage</th><th>Action</th><th>Category</th><th>Qty</th><th></th></tr></thead><tbody id="mBody"></tbody></table><button class="btn btn-sm btn-dark" onclick="addMRow()">+ Add Line</button></div>
  <div class="modal-footer"><button class="btn btn-primary" onclick="saveM()">Apply</button></div>
</div></div></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwlpwvWNsxEJBXHt9RaqpVs85jm5h33mwnHcN6eLo0VcdYxuZ7UgD9NsFZxb2KKj4UH/exec";
  let cellData = {}, activeDefs = [], masterCauses = [];
  const modal = new bootstrap.Modal(document.getElementById('eModal'));
  const slots = ["08:30","09:30","10:30","11:30","12:30","01:30","02:30","03:30","04:30","05:30","06:30"];

  window.onload = () => {
    document.getElementById('iDate').valueAsDate = new Date();
    document.getElementById('summaryDate').valueAsDate = new Date();
    slots.forEach((t, i) => {
      document.getElementById('timeRow').innerHTML += `<th>${t}</th>`;
      document.getElementById('inputRow').innerHTML += `<td><input type="number" id="hInp_${i}" class="inp-hourly" value="0" oninput="refreshTotals()"></td>`;
      document.getElementById('syncRow').innerHTML += `<th><button class="btn btn-primary btn-sync" id="btnSync_${i}" onclick="syncHour(${i})">SYNC</button></th>`;
    });
    fetch(SCRIPT_URL + "?action=getLists").then(r => r.json()).then(d => {
      masterCauses = d.causes;
      d.models.forEach(x => document.getElementById('iModel').add(new Option(x,x)));
      d.defects.forEach(x => document.getElementById('defSel').add(new Option(x,x)));
      loadDraft();
    });
  };

  function switchTab(t) {
    document.getElementById('sectionEntry').style.display = t==='entry'?'block':'none';
    document.getElementById('sectionSummary').style.display = t==='summary'?'block':'none';
    document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
    if(event) event.target.classList.add('active');
  }

  function resetShift() {
      if(confirm("Are you sure? This will delete all local data for a new shift.")) {
          localStorage.removeItem('trc_draft_final');
          location.reload();
      }
  }

  function refreshTotals() {
    let tInp = 0; for(let i=0; i<11; i++) tInp += parseInt(document.getElementById('hInp_'+i).value) || 0;
    document.getElementById('dispInp').innerText = tInp;
    let tDef = 0; for(let k in cellData) cellData[k].forEach(d => tDef += (parseInt(d.qty) || 0));
    document.getElementById('dispDef').innerText = tDef;
    document.getElementById('dispFPY').innerText = tInp > 0 ? (((tInp-tDef)/tInp)*100).toFixed(1)+"%" : "100%";
    saveDraft();
  }

  function addDefectRow(n) {
    n = n || document.getElementById('defSel').value; if(!n || activeDefs.includes(n)) return;
    activeDefs.push(n); const tr = document.createElement('tr');
    tr.innerHTML = `<td class="fw-bold text-start ps-3">${n}</td>`;
    slots.forEach((s,i) => tr.innerHTML += `<td><button class="qty-link" id="btnGrid_${n}_${i}" onclick="openM('${n}',${i})">0</button></td>`);
    document.getElementById('gridBody').appendChild(tr);
  }

  function openM(d, i) {
    const key = `${d}_${i}`; document.getElementById('mHeader').innerText = `${d} @ ${slots[i]}`;
    document.getElementById('mHeader').dataset.key = key; const b = document.getElementById('mBody'); b.innerHTML = '';
    (cellData[key] || [{cause:'', stage:'BT', action:'Change', category:'Process', qty:1}]).forEach(it => addMRow(it));
    modal.show();
  }

  function addMRow(d={}) {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><select class="form-select form-select-sm c-v">${masterCauses.map(c => `<option value="${c}" ${d.cause==c?'selected':''}>${c}</option>`).join('')}</select></td>
      <td><select class="form-select form-select-sm s-v"><option>BT</option><option>VI</option></select></td>
      <td><select class="form-select form-select-sm a-v"><option>Change</option><option>Resold</option></select></td>
      <td><select class="form-select form-select-sm cat-v"><option>Process</option><option>RMD</option><option>CKD-Califonix SMT</option></select></td>
      <td><input type="number" class="form-control form-control-sm q-v" value="${d.qty||1}"></td>
      <td><button class="btn btn-sm text-danger" onclick="this.closest('tr').remove()">x</button></td>`;
    document.getElementById('mBody').appendChild(tr);
  }

  function saveM() {
    const key = document.getElementById('mHeader').dataset.key; let list = [], tot = 0;
    document.querySelectorAll('#mBody tr').forEach(r => {
      let q = parseInt(r.querySelector('.q-v').value) || 0; tot += q;
      list.push({ cause: r.querySelector('.c-v').value, stage: r.querySelector('.s-v').value, action: r.querySelector('.a-v').value, category: r.querySelector('.cat-v').value, qty: q });
    });
    cellData[key] = list; const b = document.getElementById('btnGrid_' + key); b.innerText = tot; b.classList.toggle('has-details', tot > 0);
    modal.hide(); refreshTotals();
  }

  function syncHour(idx) {
    const hInput = document.getElementById('hInp_' + idx).value;
    const btn = document.getElementById('btnSync_' + idx);
    document.getElementById('loader').style.display = 'block';
    let hourDetails = {};
    activeDefs.forEach(def => { if(cellData[`${def}_${idx}`]) hourDetails[`${def}_${idx}`] = cellData[`${def}_${idx}`]; });
    const p = { syncType: "hourly", slotLabel: slots[idx], hourlyInput: hInput, info: { date: document.getElementById('iDate').value, line: document.getElementById('iLine').value, product: document.getElementById('iProd').value, model: document.getElementById('iModel').value, shift: document.getElementById('iShift').value }, details: hourDetails };
    fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(p) }).then(res => res.json()).then(res => { 
        document.getElementById('loader').style.display = 'none';
        btn.classList.add('btn-synced'); btn.innerText = "DONE ✓";
    });
  }

  function fetchGlobalData() {
    const targetDate = document.getElementById('summaryDate').value;
    document.getElementById('loader').style.display = 'block';
    fetch(SCRIPT_URL + "?action=getDash&date=" + targetDate).then(r => r.json()).then(d => {
      const sT = document.getElementById('sumTableBody'); sT.innerHTML = '';
      for(let l in d.lines) {
        let line = d.lines[l], rate = line.input > 0 ? ((line.rej/line.input)*100).toFixed(1) : 0;
        sT.innerHTML += `<tr><td>${l}</td><td>${line.prod}</td><td>${line.input}</td><td class="text-danger">${line.rej}</td><td>${(100-rate).toFixed(1)}%</td></tr>`;
      }
      document.getElementById('loader').style.display = 'none';
    });
  }

  function saveDraft() {
    let hInps = []; for(let i=0; i<11; i++) hInps.push(document.getElementById('hInp_'+i).value);
    localStorage.setItem('trc_draft_final', JSON.stringify({ activeDefs, cellData, hInps, line: document.getElementById('iLine').value, model: document.getElementById('iModel').value }));
  }

  function loadDraft() {
    const s = localStorage.getItem('trc_draft_final'); if(!s) return;
    const d = JSON.parse(s); document.getElementById('iLine').value = d.line;
    if(d.model) document.getElementById('iModel').value = d.model;
    d.hInps.forEach((v, i) => document.getElementById('hInp_'+i).value = v);
    cellData = d.cellData;
    d.activeDefs.forEach(def => {
      addDefectRow(def);
      for(let i=0; i<11; i++){
        let k = `${def}_${i}`;
        if(cellData[k]){
           let sum = cellData[k].reduce((a, b) => a + (parseInt(b.qty)||0), 0);
           const b = document.getElementById('btnGrid_'+k); if(b) { b.innerText = sum; b.classList.add('has-details'); }
        }
      }
    });
    refreshTotals();
  }
</script>
</body>
</html>
