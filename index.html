<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TRC Tracking Tool</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; }
    .loader { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9999; }
    .hidden { display: none !important; }
    .cursor-pointer { cursor: pointer; }
    .header-img { height: 50px; }
  </style>
</head>
<body>

<!-- Loader Spinner -->
<div id="loader" class="loader">
  <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
</div>

<!-- Header -->
<nav class="navbar navbar-light bg-white shadow-sm">
  <div class="container-fluid">
    <a class="navbar-brand d-flex align-items-center" href="#">
      <img src="https://i.postimg.cc/5y7SN4xc/logo.png" alt="Logo" class="header-img me-2">
      <span class="fw-bold text-primary">TRC Tracking System</span>
    </a>
  </div>
</nav>

<div class="container mt-4">
  <!-- Navigation Tabs -->
  <ul class="nav nav-pills mb-3 gap-2" id="pills-tab">
    <li class="nav-item"><button class="nav-link active" onclick="showTab('tab1')">TRC IN</button></li>
    <li class="nav-item"><button class="nav-link" onclick="loadPhase2()">Repair Entry</button></li>
    <li class="nav-item"><button class="nav-link" onclick="loadPhase3()">TRC OUT</button></li>
    <li class="nav-item"><button class="nav-link" onclick="loadReports()">Dashboard</button></li>
    <li class="nav-item"><button class="nav-link btn-danger text-danger border border-danger" onclick="showTab('tab7')">Opening Stock</button></li>
  </ul>

  <!-- ERROR ALERT -->
  <div id="alertBox" class="alert alert-info hidden"></div>

  <!-- TAB 1: TRC IN -->
  <div id="tab1" class="tab-content">
    <div class="card shadow-sm p-4">
      <h5 class="mb-3 text-primary">Phase 1: New Entry</h5>
      <form id="formPhase1">
        <div class="row g-3">
          <div class="col-md-3"><label class="form-label">Date</label><input type="date" id="t1Date" class="form-control"></div>
          <div class="col-md-3"><label class="form-label">Time</label><input type="time" id="t1Time" class="form-control"></div>
          <div class="col-md-3"><label class="form-label">Line No</label><input type="text" id="t1Line" class="form-control"></div>
          <div class="col-md-3"><label class="form-label">Model</label><input type="text" id="t1Model" class="form-control"></div>
          <div class="col-md-3"><label class="form-label">Qty</label><input type="number" id="t1Qty" class="form-control"></div>
          <div class="col-md-9"><label class="form-label">Defect</label><input type="text" id="t1Defect" class="form-control"></div>
        </div>
        <button type="button" class="btn btn-primary mt-3" onclick="submitPhase1()">Save Entry</button>
      </form>
    </div>
  </div>

  <!-- TAB 2: REPAIR -->
  <div id="tab2" class="tab-content hidden">
    <div class="card shadow-sm p-4">
      <h5 class="mb-3 text-warning">Phase 2: Pending Repair</h5>
      <div class="table-responsive">
        <table class="table table-hover table-bordered align-middle">
          <thead class="table-light"><tr><th>Line</th><th>Model</th><th>Qty</th><th>Defect</th><th>Action</th></tr></thead>
          <tbody id="p2TableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- TAB 3: OUT -->
  <div id="tab3" class="tab-content hidden">
    <div class="card shadow-sm p-4">
      <h5 class="mb-3 text-success">Phase 3: Ready for Dispatch</h5>
      <div class="table-responsive">
        <table class="table table-hover table-bordered align-middle">
          <thead class="table-light"><tr><th>Model</th><th>Repaired Qty</th><th>Engineer</th><th>Action</th></tr></thead>
          <tbody id="p3TableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- TAB 4: REPORTS -->
  <div id="tab4" class="tab-content hidden">
    <div class="card shadow-sm p-4">
      <h5 class="mb-3">Live Status</h5>
      <div class="row text-center">
        <div class="col-md-6 mb-3">
          <div class="p-3 bg-warning bg-opacity-10 border border-warning rounded">
            <h3>Pending Repair</h3>
            <h1 id="countPending" class="display-4 fw-bold text-warning">0</h1>
          </div>
        </div>
        <div class="col-md-6 mb-3">
          <div class="p-3 bg-success bg-opacity-10 border border-success rounded">
            <h3>Completed (Closed)</h3>
            <h1 id="countClosed" class="display-4 fw-bold text-success">0</h1>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- TAB 7: OPENING -->
  <div id="tab7" class="tab-content hidden">
    <div class="card shadow-sm p-4 border-danger">
      <h5 class="text-danger">Month Opening Entry</h5>
      <div class="row g-3">
          <div class="col-md-3"><label>Date</label><input type="date" id="t7Date" class="form-control"></div>
          <div class="col-md-3"><label>Line</label><input type="text" id="t7Line" class="form-control"></div>
          <div class="col-md-3"><label>Model</label><input type="text" id="t7Model" class="form-control"></div>
          <div class="col-md-3"><label>Opening Qty</label><input type="number" id="t7Qty" class="form-control"></div>
      </div>
      <button type="button" class="btn btn-danger mt-3" onclick="submitPhase1(true)">Save Opening</button>
    </div>
  </div>

</div>

<!-- REPAIR MODAL -->
<div class="modal fade" id="repairModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-warning bg-opacity-25">
        <h5 class="modal-title">Repair Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="modalRowId">
        <div class="row g-3">
            <div class="col-md-4"><label>Qty Repair</label><input type="number" id="modalRepQty" class="form-control"></div>
            <div class="col-md-4"><label>RCA</label><input type="text" id="modalRCA" class="form-control"></div>
            <div class="col-md-4">
                <label>Action</label>
                <select id="modalAction" class="form-select" onchange="toggleComp()">
                    <option value="Reflow">Reflow</option>
                    <option value="Change">Change</option>
                </select>
            </div>
            <div class="col-md-6 hidden" id="compDiv">
                <label class="text-danger fw-bold">Component Name</label>
                <input type="text" id="modalComp" class="form-control border-danger">
            </div>
            <div class="col-md-6"><label>Engineer Name</label><input type="text" id="modalEng" class="form-control"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" onclick="submitRepair()">Submit Repair</button>
      </div>
    </div>
  </div>
</div>

<!-- JS LIBRARY -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // **********************************************
  // PASTE YOUR NEW WEB APP URL HERE
  // **********************************************
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzohfK68ElBF4jJ-zsv60OGsA4XO6kDSopGqT1p7ItZTcV98TE9VSMkYhJejd6qt91yUQ/exec"; 
  
  // Helper: Show/Hide Loader
  function loading(isLoading) {
    document.getElementById('loader').style.display = isLoading ? 'block' : 'none';
  }

  // Helper: API Caller
  function apiCall(mode, payload, callback) {
    loading(true);
    
    // Setup Request
    let url = SCRIPT_URL;
    let options = { method: "POST" };
    
    if (mode === "GET") {
        url += "?action=" + payload.action + "&phase=" + (payload.phase || "");
    } else {
        // POST request must be 'text/plain' to avoid CORS preflight options issues in GAS
        options.body = JSON.stringify(payload);
        options.headers = { "Content-Type": "text/plain" }; 
    }

    fetch(url, options)
    .then(res => res.json())
    .then(data => {
        loading(false);
        callback(data);
    })
    .catch(err => {
        loading(false);
        alert("Error: " + err);
        console.error(err);
    });
  }

  // TABS
  function showTab(id) {
    document.querySelectorAll('.tab-content').forEach(d => d.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
    document.querySelectorAll('.nav-link').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
  }

  // PHASE 1: SUBMIT
  function submitPhase1(isOpening = false) {
    let prefix = isOpening ? "t7" : "t1";
    let data = {
        date: document.getElementById(prefix+'Date').value,
        time: isOpening ? "00:00" : document.getElementById(prefix+'Time').value,
        line: document.getElementById(prefix+'Line').value,
        model: document.getElementById(prefix+'Model').value,
        qty: document.getElementById(prefix+'Qty').value,
        defect: isOpening ? "Opening" : document.getElementById(prefix+'Defect').value,
        isOpening: isOpening ? "Yes" : "No"
    };

    if(!data.date || !data.line || !data.qty) { alert("Please fill details"); return; }

    apiCall("POST", { action: "saveEntry", data: data }, (res) => {
        alert(res.message);
        if(!isOpening) document.getElementById('formPhase1').reset();
    });
  }

  // PHASE 2: LOAD
  function loadPhase2() {
    showTab('tab2');
    apiCall("GET", { action: "getData", phase: 2 }, (res) => {
        let html = "";
        res.forEach(item => {
            html += `<tr>
                <td>${item.data[3]}</td>
                <td>${item.data[4]}</td>
                <td>${item.data[5]}</td>
                <td>${item.data[6]}</td>
                <td><button class="btn btn-sm btn-warning" onclick="openRepair(${item.row})">Repair</button></td>
            </tr>`;
        });
        document.getElementById('p2TableBody').innerHTML = html || '<tr><td colspan="5">No Pending Repairs</td></tr>';
    });
  }

  // REPAIR MODAL LOGIC
  var modalObj;
  function openRepair(rowId) {
    document.getElementById('modalRowId').value = rowId;
    modalObj = new bootstrap.Modal(document.getElementById('repairModal'));
    modalObj.show();
  }
  
  function toggleComp() {
     let act = document.getElementById('modalAction').value;
     document.getElementById('compDiv').classList.toggle('hidden', act !== "Change");
  }

  function submitRepair() {
    let data = {
        rowId: document.getElementById('modalRowId').value,
        repQty: document.getElementById('modalRepQty').value,
        rca: document.getElementById('modalRCA').value,
        action: document.getElementById('modalAction').value,
        comp: document.getElementById('modalComp').value,
        eng: document.getElementById('modalEng').value
    };
    
    apiCall("POST", { action: "updateRepair", data: data }, (res) => {
        alert(res.message);
        modalObj.hide();
        loadPhase2();
    });
  }

  // PHASE 3: LOAD
  function loadPhase3() {
    showTab('tab3');
    apiCall("GET", { action: "getData", phase: 3 }, (res) => {
        let html = "";
        res.forEach(item => {
            html += `<tr>
                <td>${item.data[4]}</td>
                <td>${item.data[7]}</td>
                <td>${item.data[11]}</td>
                <td>
                    <div class="input-group input-group-sm">
                        <input type="number" id="outQty_${item.row}" class="form-control" placeholder="Out Qty">
                        <button class="btn btn-success" onclick="submitOut(${item.row})">Dispatch</button>
                    </div>
                </td>
            </tr>`;
        });
        document.getElementById('p3TableBody').innerHTML = html || '<tr><td colspan="4">No Data</td></tr>';
    });
  }

  function submitOut(rowId) {
    let qty = document.getElementById('outQty_'+rowId).value;
    if(!qty) return alert("Enter Qty");

    let today = new Date();
    let data = {
        rowId: rowId,
        outQty: qty,
        outDate: today.toISOString().split('T')[0],
        outTime: today.toTimeString().split(' ')[0].slice(0,5)
    };

    apiCall("POST", { action: "updateOut", data: data }, (res) => {
        alert(res.message);
        loadPhase3();
    });
  }

  // REPORTS
  function loadReports() {
    showTab('tab4');
    apiCall("GET", { action: "getDashboard" }, (data) => {
        let pending = 0, closed = 0;
        // Skip header index 0
        for(let i=1; i<data.length; i++) {
            if(data[i][15] === "Pending Repair") pending++;
            if(data[i][15] === "Closed") closed++;
        }
        document.getElementById('countPending').innerText = pending;
        document.getElementById('countClosed').innerText = closed;
    });
  }
</script>

</body>
</html>