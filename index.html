<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>TRC In/Out Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f4f6f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    
    /* Login Styles */
    .login-container { max-width: 400px; margin: 80px auto; padding: 30px; background: white; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    
    /* Main App Styles */
    .main-container { display: none; max-width: 100%; margin: 20px; background: white; padding: 20px; box-shadow: 0 0 15px rgba(0,0,0,0.1); border-radius: 8px; }
    
    /* Table Grid */
    .table-container { overflow-x: auto; }
    .report-table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 1200px; }
    .report-table th, .report-table td { border: 1px solid #ccc; padding: 0; text-align: center; height: 30px; }
    .report-table th { background-color: #f1f3f5; font-weight: 600; padding: 5px; }
    
    /* Defect Column (Fixed Width) */
    .defect-col { text-align: left !important; width: 180px; min-width: 180px; padding-left: 8px !important; font-weight: 500; background-color: #fff; position: sticky; left: 0; z-index: 10; border-right: 2px solid #ddd; }
    
    /* Inputs */
    .grid-input { width: 100%; height: 100%; border: none; text-align: center; outline: none; background: transparent; }
    .grid-input:focus { background-color: #e8f0fe; font-weight: bold; }
    .grid-input:hover { background-color: #f8f9fa; }
    
    /* Totals */
    .total-cell { background-color: #e9ecef; font-weight: bold; color: #333; }
    
    /* Loader */
    .loader { display: none; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #0d6efd; border-radius: 50%; animation: spin 1s linear infinite; vertical-align: middle; margin-left: 10px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <!-- LOGIN SCREEN -->
  <div id="loginScreen" class="login-container">
    <div class="text-center mb-4">
       <!-- Replace with your logo URL -->
       <img src="https://via.placeholder.com/150x50?text=Company+Logo" alt="Logo" style="height:50px;">
       <h4 class="mt-3">TRC Login</h4>
    </div>
    <div class="mb-3">
      <label class="form-label">Line Username</label>
      <input type="text" id="username" class="form-control" placeholder="e.g. Line01">
    </div>
    <div class="mb-3">
      <label class="form-label">Password</label>
      <input type="password" id="password" class="form-control" placeholder="Password">
    </div>
    <button onclick="attemptLogin()" id="loginBtn" class="btn btn-primary w-100">
      Login <div id="loginLoader" class="loader"></div>
    </button>
    <p id="loginMsg" class="text-danger mt-3 text-center small"></p>
  </div>

  <!-- MAIN APP SCREEN -->
  <div id="appScreen" class="main-container">
    <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
      <img src="https://via.placeholder.com/150x50?text=Company+Logo" alt="Logo" style="height:40px;">
      <h3 class="m-0">TRC In/Out Report</h3>
      <button onclick="logout()" class="btn btn-outline-danger btn-sm">Logout</button>
    </div>

    <!-- Controls -->
    <div class="row g-2 mb-3 align-items-end" style="background: #f8f9fa; padding: 10px; border-radius: 6px;">
      <div class="col-md-2 col-6"><label class="small fw-bold">Date</label><input type="date" id="reportDate" class="form-control form-control-sm"></div>
      <div class="col-md-2 col-6"><label class="small fw-bold">Line No</label><input type="text" id="lineNo" class="form-control form-control-sm" readonly style="background-color: #e9ecef;"></div>
      <div class="col-md-2 col-6"><label class="small fw-bold">Model</label><input type="text" id="modelName" class="form-control form-control-sm" placeholder="AD 131"></div>
      <div class="col-md-1 col-6"><label class="small fw-bold">Shift</label><select id="shiftId" class="form-select form-select-sm"><option value="A">A</option><option value="B">B</option><option value="C">C</option></select></div>
      <div class="col-md-2 col-6"><label class="small fw-bold">Type</label><select id="typeId" class="form-select form-select-sm"><option value="Online">Online</option><option value="Offline">Offline</option></select></div>
      <div class="col-md-3 text-end">
         <button onclick="loadData()" id="loadBtn" class="btn btn-info btn-sm text-white w-100 fw-bold">
           Load Existing Data <div id="loadLoader" class="loader"></div>
         </button>
      </div>
    </div>

    <!-- Data Grid -->
    <div class="table-container">
      <table class="report-table" id="mainTable">
        <thead>
          <tr id="timeHeader1"><th rowspan="2" style="width:180px; z-index:11" class="defect-col">Defect / Time</th></tr>
          <tr id="timeHeader2"></tr>
        </thead>
        <tbody id="tableBody"></tbody>
        <tfoot>
           <tr id="footerRow"><td class="defect-col total-cell">G.Total</td></tr>
        </tfoot>
      </table>
    </div>

    <!-- Actions -->
    <div class="mt-4 text-center">
      <button onclick="saveData()" id="saveBtn" class="btn btn-success px-5 fw-bold">
        Save Data <div id="saveLoader" class="loader"></div>
      </button>
      <button onclick="window.print()" class="btn btn-secondary px-4 ms-2">Preview / Print</button>
    </div>
  </div>

  <script>
    // ******************************************************************
    // ⚠️ PASTE YOUR GOOGLE DEPLOYMENT URL INSIDE THE QUOTES BELOW
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxME3GRRZe0e2_YPfcFOemUK-maPVLrwgfY4mPzM654h3bvUXl9MO3Q5EPvs3kBuPFx/exec"; 
    // ******************************************************************

    const timeSlots = [
      { start: "08:30", end: "09:30" }, { start: "09:30", end: "10:30" }, { start: "10:30", end: "11:30" },
      { start: "11:30", end: "12:30" }, { start: "12:30", end: "01:30" }, { start: "01:30", end: "02:30" },
      { start: "02:30", end: "03:30" }, { start: "03:30", end: "04:30" }, { start: "04:30", end: "05:30" },
      { start: "05:30", end: "06:30" }, { start: "06:30", end: "07:30" }
    ];

    const defects = [
      "Not On", "Speaker Fail", "Mic Fail", "Channel Detection", "Hard Glue", "RF Fail", "Sensor Fail", 
      "Cavity Crack", "LED Issue", "Dent,Scratch", "Pogo Pin Issue", "Buds Heating", "Dut Mode", 
      "BT not connect", "Distortion", "Body Sensor", "Not Pairing", "Inquiry Fail", "Electric Sound", 
      "Polarity Reverse", "Low Current", "Battery Drain", "Gap", "High Current", "Hall Sensor", 
      "Key Issue", "Low Sound", "Magnet Issue", "Component Damage", "Unpair", "ANC Fail", 
      "Software PCBA/Model Mixing", "Buds Not Disconnect", "Scrap"
    ];

    window.onload = function() {
      document.getElementById('reportDate').valueAsDate = new Date();
      generateTable();
    };

    function generateTable() {
      const h1 = document.getElementById('timeHeader1');
      const h2 = document.getElementById('timeHeader2');
      const tbody = document.getElementById('tableBody');
      const tfoot = document.getElementById('footerRow');

      // Headers
      timeSlots.forEach(slot => {
        let th1 = document.createElement('th'); th1.innerText = slot.start; h1.appendChild(th1);
        let th2 = document.createElement('th'); th2.innerText = slot.end; h2.appendChild(th2);
      });
      h1.appendChild(document.createElement('th')).innerText = "G.Total";
      h2.appendChild(document.createElement('th'));

      // Body
      defects.forEach((defect, rIndex) => {
        let tr = document.createElement('tr');
        
        // Defect Name
        let tdName = document.createElement('td'); 
        tdName.className = 'defect-col'; 
        tdName.innerText = defect; 
        tr.appendChild(tdName);

        // Inputs
        timeSlots.forEach((_, cIndex) => {
          let td = document.createElement('td');
          let input = document.createElement('input');
          input.type = "number"; 
          input.className = "grid-input"; 
          input.id = `cell-${rIndex}-${cIndex}`;
          // Optimize performance: only calculate on 'change' (lost focus), not every keypress
          input.onchange = calculateTotals; 
          td.appendChild(input); 
          tr.appendChild(td);
        });

        // Row Total
        let tdTotal = document.createElement('td'); 
        tdTotal.className = 'total-cell'; 
        tdTotal.id = `row-total-${rIndex}`; 
        tdTotal.innerText = "0";
        tr.appendChild(tdTotal);
        
        tbody.appendChild(tr);
      });

      // Footer
      timeSlots.forEach((_, cIndex) => {
        let td = document.createElement('td'); 
        td.className = 'total-cell'; 
        td.id = `col-total-${cIndex}`; 
        td.innerText = "0";
        tfoot.appendChild(td);
      });
      let tdFinal = document.createElement('td'); 
      tdFinal.className = 'total-cell'; 
      tdFinal.id = 'grand-total-all'; 
      tdFinal.innerText = "0";
      tfoot.appendChild(tdFinal);
    }

    function calculateTotals() {
      let grandTotalAll = 0;
      
      // Row Totals
      defects.forEach((_, rIndex) => {
        let rowSum = 0;
        timeSlots.forEach((_, cIndex) => {
          let val = document.getElementById(`cell-${rIndex}-${cIndex}`).value;
          rowSum += (val === "" ? 0 : parseFloat(val));
        });
        document.getElementById(`row-total-${rIndex}`).innerText = rowSum;
        grandTotalAll += rowSum;
      });

      // Column Totals
      timeSlots.forEach((_, cIndex) => {
        let colSum = 0;
        defects.forEach((_, rIndex) => {
          let val = document.getElementById(`cell-${rIndex}-${cIndex}`).value;
          colSum += (val === "" ? 0 : parseFloat(val));
        });
        document.getElementById(`col-total-${cIndex}`).innerText = colSum;
      });

      document.getElementById('grand-total-all').innerText = grandTotalAll;
    }

    // --- API FUNCTIONS ---

    function toggleLoader(id, show) {
      const loader = document.getElementById(id);
      if(loader) loader.style.display = show ? 'inline-block' : 'none';
    }

    async function attemptLogin() {
      const u = document.getElementById('username').value.trim();
      const p = document.getElementById('password').value.trim();
      const msg = document.getElementById('loginMsg');
      const btn = document.getElementById('loginBtn');
      
      if(!u || !p) { msg.innerText = "Please enter both fields"; return; }

      msg.innerText = "";
      btn.disabled = true;
      toggleLoader('loginLoader', true);

      try {
        const url = `${SCRIPT_URL}?action=login&user=${encodeURIComponent(u)}&pass=${encodeURIComponent(p)}`;
        const response = await fetch(url);
        const data = await response.json();

        if (data.status === 'success') {
           document.getElementById('loginScreen').style.display = 'none';
           document.getElementById('appScreen').style.display = 'block';
           document.getElementById('lineNo').value = data.username;
        } else {
           msg.innerText = data.message || "Invalid Login";
        }
      } catch (e) {
        msg.innerText = "Connection Failed. Ensure the script is deployed as 'Anyone'.";
        console.error(e);
      }
      
      btn.disabled = false;
      toggleLoader('loginLoader', false);
    }

    async function saveData() {
      const d = document.getElementById('reportDate').value;
      const m = document.getElementById('modelName').value.trim();
      
      if(!d || !m) { alert("Please select Date and enter Model Name."); return; }

      const btn = document.getElementById('saveBtn');
      btn.disabled = true;
      toggleLoader('saveLoader', true);

      // Collect Data
      let gridData = [];
      defects.forEach((_, rIndex) => {
        let rowData = [];
        timeSlots.forEach((_, cIndex) => {
          let val = document.getElementById(`cell-${rIndex}-${cIndex}`).value;
          rowData.push(val === "" ? 0 : val);
        });
        gridData.push(rowData);
      });

      const payload = {
        date: d,
        line: document.getElementById('lineNo').value,
        model: m,
        shift: document.getElementById('shiftId').value,
        gridData: gridData
      };

      try {
        // Send via POST text/plain to avoid CORS preflight issues
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify(payload)
        });
        
        const result = await response.json();
        
        if(result.status === 'success') {
          alert("Data Saved Successfully!");
        } else {
          alert("Error saving: " + result.message);
        }
      } catch (e) {
        // Sometimes Google Script saves correctly but returns a CORS error to the browser
        // If this happens, we check the catch block.
        console.error(e);
        alert("Request sent. Please check sheet if data arrived. (CORS Warning)"); 
      }

      btn.disabled = false;
      toggleLoader('saveLoader', false);
    }

    async function loadData() {
      const d = document.getElementById('reportDate').value;
      const l = document.getElementById('lineNo').value;
      const s = document.getElementById('shiftId').value;
      
      const btn = document.getElementById('loadBtn');
      btn.disabled = true;
      toggleLoader('loadLoader', true);

      try {
        const url = `${SCRIPT_URL}?action=load&date=${d}&line=${l}&shift=${s}`;
        const response = await fetch(url);
        const data = await response.json();

        if(data.found) {
          document.getElementById('modelName').value = data.model;
          
          // Fill Grid
          data.gridData.forEach((row, rIndex) => {
            row.forEach((val, cIndex) => {
              // Only fill if val is not 0 to keep UI clean
              let input = document.getElementById(`cell-${rIndex}-${cIndex}`);
              input.value = (val == 0) ? "" : val;
            });
          });
          calculateTotals();
          alert("Data loaded successfully.");
        } else {
          alert("No existing report found for this Date/Shift.");
          // Clear grid
          document.querySelectorAll('.grid-input').forEach(i => i.value = "");
          document.getElementById('modelName').value = "";
          calculateTotals();
        }
      } catch(e) {
        alert("Error loading data.");
        console.error(e);
      }

      btn.disabled = false;
      toggleLoader('loadLoader', false);
    }

    function logout() { location.reload(); }
  </script>
</body>
</html>
